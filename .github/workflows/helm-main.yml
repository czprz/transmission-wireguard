name: Helm Main

"on":
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.6.1

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Lint chart
        run: helm lint . --strict

      - name: Chart-testing lint
        run: ct lint --all --chart-dirs .

      - name: Render chart
        run: helm template transmission-wireguard . > /tmp/manifest.yaml

      - name: Kubeconform
        run: |
          KUBECONFORM_VERSION=0.6.7
          curl -sSL "https://github.com/yannh/kubeconform/releases/download/v${KUBECONFORM_VERSION}/kubeconform-linux-amd64.tar.gz" \
            | tar -xz
          sudo mv kubeconform /usr/local/bin/kubeconform
          kubeconform -strict -ignore-missing-schemas -kubernetes-version 1.29.0 /tmp/manifest.yaml

      - name: Helm unittest
        run: |
          docker run --rm \
            -u "$(id -u):$(id -g)" \
            -v "${GITHUB_WORKSPACE}:/apps" \
            helmunittest/helm-unittest:3.11.1-0.3.0 .


  release:
    runs-on: ubuntu-latest
    needs: verify
    if: github.actor != 'github-actions[bot]'
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Read current chart version
        id: chart
        uses: mikefarah/yq@v4
        with:
          cmd: yq -r '.version' Chart.yaml

      - name: Determine recommended bump
        id: bump
        run: |
          BUMP=$(npx -y -p conventional-recommended-bump -p conventional-changelog-angular \
            conventional-recommended-bump -p angular || true)
          if [ -z "${BUMP}" ]; then
            echo "bump=none" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "bump=${BUMP}" >> "$GITHUB_OUTPUT"

      - name: Compute next version
        id: next
        if: steps.bump.outputs.bump != 'none'
        run: |
          CURRENT="${{ steps.chart.outputs.result }}"
          BUMP="${{ steps.bump.outputs.bump }}"
          if ! echo "${CURRENT}" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Chart.yaml version must be x.y.z"
            exit 1
          fi
          IFS='.' read -r major minor patch <<<"${CURRENT}"
          case "${BUMP}" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
            *)
              echo "Unsupported bump: ${BUMP}"
              exit 1
              ;;
          esac
          NEW_VERSION="${major}.${minor}.${patch}"
          echo "new_version=${NEW_VERSION}" >> "$GITHUB_OUTPUT"
        env:
          CURRENT: ${{ steps.chart.outputs.result }}
          BUMP: ${{ steps.bump.outputs.bump }}

      - name: Update Chart.yaml version
        if: steps.bump.outputs.bump != 'none'
        run: yq -i '.version = strenv(NEW_VERSION)' Chart.yaml
        env:
          NEW_VERSION: ${{ steps.next.outputs.new_version }}

      - name: Update CHANGELOG
        if: steps.bump.outputs.bump != 'none'
        run: |
          touch CHANGELOG.md
          npx -y -p conventional-changelog-cli -p conventional-changelog-angular \
            conventional-changelog -p angular -i CHANGELOG.md -s -r 0

      - name: Build release notes
        if: steps.bump.outputs.bump != 'none'
        run: |
          npx -y -p conventional-changelog-cli -p conventional-changelog-angular \
            conventional-changelog -p angular -r 1 > RELEASE_BODY.md

      - name: Commit and tag
        if: steps.bump.outputs.bump != 'none'
        run: |
          if [ -z "${{ steps.next.outputs.new_version }}" ]; then
            echo "No new version computed."
            exit 0
          fi
          git remote set-url origin "https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Chart.yaml CHANGELOG.md
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "chore(release): v${{ steps.next.outputs.new_version }}"
          git tag "v${{ steps.next.outputs.new_version }}"
          git push
          git push --tags

      - name: Trigger Helm Release workflow
        if: steps.bump.outputs.bump != 'none'
        run: |
          gh workflow run helm-release.yml --ref "v${{ steps.next.outputs.new_version }}"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Create GitHub release
        if: steps.bump.outputs.bump != 'none'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.next.outputs.new_version }}
          name: v${{ steps.next.outputs.new_version }}
          body_path: RELEASE_BODY.md

      - name: Cleanup release notes
        if: always()
        run: rm -f RELEASE_BODY.md
